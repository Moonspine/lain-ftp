10 CLS
20 OPEN "COM1:19200,N,8,1" AS #1
30 GOSUB 6000
40 END
6000 REM ====================
6010 REM | DOWNLOAD command |
6020 REM ====================
6030 PRINT "Enter filename to download from the server (empty line to cancel)"
6040 INPUT DOWNLOADFILENAME$
6050 IF LEN(DOWNLOADFILENAME$) = 0 THEN RETURN
6060 PRINT "Enter filename to save to (empty line to cancel)"
6070 INPUT TARGETFILENAME$
6080 IF LEN(TARGETFILENAME$) = 0 THEN RETURN
6090 GOSUB 6200
6100 RETURN
6200 REM =========================================================
6210 REM | Download file in DOWNLOADFILENAME$ to TARGETFILENAME$ |
6220 REM =========================================================
6230 PRINT "Downloading " + DOWNLOADFILENAME$ + " to " + TARGETFILENAME$
6240 LET PACKETSIZE = 32
6250 PRINT# 1, "DOWNLOADA " + DOWNLOADFILENAME$ + " " + STR$(PACKETSIZE) + " ASCII" + CHR$(10)
6260 INPUT# 1, EXPECTEDFILESIZESTRING$
6270 LET EXPECTEDFILESIZE = VAL(EXPECTEDFILESIZESTRING$)
6280 IF EXPECTEDFILESIZE < 1 THEN PRINT "Error encountered" : PRINT EXPECTEDFILESIZESTRING$ : RETURN
6290 REM Open and close the file to delete its contents safely
6300 OPEN "O", #2, TARGETFILENAME$
6310 CLOSE #2
6320 PRINT# 1, EXPECTEDFILESIZESTRING$ + CHR$(10)
6330 OPEN "R", #2, TARGETFILENAME$, 1
6340 FIELD #2, 1 AS FILEDATA$
6350 LET CURRENTOFFSET = 0
6360 LET TOTALPACKETS = -INT(-EXPECTEDFILESIZE / PACKETSIZE)
6370 LET CURRENTPACKET = 1
6400 LET EXPECTEDPACKETSIZE = EXPECTEDFILESIZE - CURRENTOFFSET
6410 IF EXPECTEDPACKETSIZE > PACKETSIZE THEN LET EXPECTEDPACKETSIZE = PACKETSIZE
6420 PRINT "Receiving packet " + STR$(CURRENTPACKET) + " / " + STR$(TOTALPACKETS) + " (" + STR$(EXPECTEDPACKETSIZE) + " bytes)"
6430 INPUT# 1, PACKET$
6440 IF LEN(PACKET$) < EXPECTEDPACKETSIZE * 2 THEN PRINT# 1, (LEN(PACKET$) / 2) : PRINT "Packet error; retrying" : GOTO 6400
6450 FOR I = 1 TO EXPECTEDPACKETSIZE
6460 LET OFFSET = I * 2 - 1
6470 LET NYBBLECHAR$ = MID$(PACKET$, OFFSET, 1)
6480 GOSUB 6800
6490 LET FILEBYTEDATA = NYBBLE * 16
6500 LET NYBBLECHAR$ = MID$(PACKET$, OFFSET + 1, 1)
6510 GOSUB 6800
6520 LET FILEBYTEDATA = FILEBYTEDATA + NYBBLE
6530 LSET FILEDATA$ = CHR$(FILEBYTEDATA)
6540 PUT #2
6550 NEXT I
6560 PRINT# 1, STR$(EXPECTEDPACKETSIZE) + CHR$(10)
6570 LET CURRENTOFFSET = CURRENTOFFSET + EXPECTEDPACKETSIZE
6580 IF CURRENTOFFSET < EXPECTEDFILESIZE THEN LET CURRENTPACKET = CURRENTPACKET + 1 : GOTO 6400
6590 CLOSE #2
6600 PRINT "File downloaded successfully"
6610 PRINT ""
6620 RETURN
6800 REM Converts nybble character in NYBBLECHAR$ to integer in NYBBLE
6810 LET NYBBLECHARASC = ASC(NYBBLECHAR$)
6820 IF NYBBLECHARASC >= 48 AND NYBBLECHARASC <= 57 THEN NYBBLE = NYBBLECHARASC - 48 : RETURN
6830 IF NYBBLECHARASC >= 65 AND NYBBLECHARASC <= 70 THEN NYBBLE = NYBBLECHARASC - 55 : RETURN
6840 IF NYBBLECHARASC >= 97 AND NYBBLECHARASC <= 102 THEN NYBBLE = NYBBLECHARASC - 87 : RETURN
6850 NYBBLE = 0
6860 RETURN
